pipeline {
    agent any

    stages {

        stage('Job1-Build') {
            steps {
                echo 'Building Docker Image'
                sh 'docker build -t abode-webapp .'
            }
        }

        stage('Job2-Test') {
            steps {
                echo 'Testing Application'
                sh '''
                docker run -d --name test-app -p 8081:80 abode-webapp
                sleep 10
                docker ps
                docker rm -f test-app
                '''
            }
        }

        stage('Job3-Prod') {
            when {
                branch 'master'
            }
            steps {
                echo 'Deploying to Production'
                sh '''
                docker rm -f prod-app || true
                docker run -d --name prod-app -p 80:80 abode-webapp
                '''
            }
        }
    }

    post {
        always {
            echo 'Pipeline Execution Completed'
        }
    }
}
